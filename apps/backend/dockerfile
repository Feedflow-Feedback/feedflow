# Build stage
FROM node:23-alpine AS build

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy monorepo files
COPY pnpm-workspace.yaml ./
COPY package.json ./

# Copy the NestJS app and shared packages
COPY apps/backend ./apps/backend
COPY packages/ui ./packages/ui
COPY packages/utils ./packages/utils
COPY packages/eslint-config ./packages/eslint-config
COPY packages/typescript-config ./packages/typescript-config

# Install dependencies
RUN pnpm install

# Build the NestJS app
RUN pnpm --filter ./apps/backend... run build

FROM node:23-alpine

RUN npm install -g serve

WORKDIR /app

# Copy the built dashboard frontend files from build stage
COPY --from=build /app/apps/backend/dist ./dist

EXPOSE 3000

CMD ["serve", "dist", "-l", "3000"]
